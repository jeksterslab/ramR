---
title: "Equations"
author: "Ivan Jacob Agaloos Pesigan"
date: "`r Sys.Date()`"
description: >
  Learn how to define structural equations in `ramR`.
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Equations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

`Eq*` functions in the `ramR` package requires an input 
which is a character string that specifies the associations between the variables.
Each line in the character string is a structural equation linking two variables at a time.

## Syntax

Each line should follow the syntax below

```
lhs <space> op <space> rhs <space> par.label <space> par.start <\n> or <;>
```

The elements in the syntax are as follows:

- **`lhs`** is the variable on the left-hand side,
- **`rhs`** is the variable on the right-hand side,
- **`op`** is the operation between `lhs` and `rhs`,
- **`par.label`** is the column of parameter label,
- **`par.start`** is the column of starting values for estimation
  (only for functions that require it), and
- **`\n`** or **`;`** are line breaks.
  **Each line should end with a line break.**


### Operations

The associations are defined by the following operations:

- `left-hand side` measured **`by`** `right-hand side`,
- `left-hand side` regressed **`on`** `right-hand side`,
- `left-hand side` covarying **`with`** `right-hand side`, and
- `left-hand side` regressed **`on 1`** for mean structure.

### par.label

Each parameter should be labeled.
The `par.label` should be a number for fixed parameters
and a character string for free parameters.
Equality contraints can be imposed by using the same `par.label`.

### par.start

Numerical values as starting values for estimation.
Starting values for fixed parameters should be `NA`.
Starting values should be identical
for parameters constrained to be equal,
that is, parameters with the same `par.label`.

### Line breaks

The characters `\n` and `;` can be used as line breaks.
**Each line should end with a line break.**

### Comments

Comments can be written after a hash (`#`) sign.

## Confirmatory Factor Analysis Example

In the following example let `y1` to `y9` be observed variables
and `F1` to `F3` be latent variables.
Let `y1` to `y3` be indicators of `F1`,
`y4` to `y6` of `F2`, and
`y7` to `y8` of `F3`.
The first indicator of the latent variable has a factor loading of $1$.
The latent variables are correlated.
The item factor loadings are labeled with `l*`,
the item intercepts are labeled with `u*`,
the item residual variances are labeled with `e*`,
and the latent variable covariances are labeled with `r*`.
The structural equations can be defined as follows

```{r}
eq <- "
# lhs op   rhs par.label
# factor loadings
  F1  by   y1  1
  F1  by   y2  l2
  F1  by   y3  l3
  F2  by   y4  1
  F2  by   y5  l5
  F2  by   y6  l6
  F3  by   y7  1
  F3  by   y8  l8
  F3  by   y9  l9
# intercepts
  y1  on   1   u1
  y2  on   1   u2
  y3  on   1   u3
  y4  on   1   u4
  y5  on   1   u5
  y6  on   1   u6
  y7  on   1   u7
  y8  on   1   u8
  y9  on   1   u9
# residual variances
  y1  with y1  e1
  y2  with y2  e2
  y3  with y3  e3
  y4  with y4  e4
  y5  with y5  e5
  y6  with y6  e6
  y7  with y7  e7
  y8  with y8  e8
  y9  with y9  e9
# covariances
  F1  with F1  r11
  F1  with F2  r12
  F1  with F3  r13
  F2  with F2  r22
  F2  with F3  r23
  F3  with F3  r33
"
```

### EqParse

The `EqParse()` function can parse the defined equation
and setup labels for the unknown parameters.

```{r}
ramR::EqParse(eq)
```

### Symbolic

#### Eq2RAM

The `Eq2RAM()` function constructs
the RAM notation matrix representation of the model.

```{r}
ramR::Eq2RAM(eq)
```

#### Eq2Expectations

The `Eq2Expectations()` function constructs the
mean and covariance expectations.

```{r}
Expectations <- ramR::Eq2Expectations(eq)
```

The covariance expectations for the observed variables `y1` to `y9`
are given below.

```{r, echo = FALSE, results = "asis"} 
latex <- ramR::Eq2Expectations(eq, format = "tex")
cat(
  "\\begin{align*}",
  latex$M,
  "\\end{align*}",
  sep = ""
)
```

The mean expectations for the observed variables `y1` to `y9`
are given below.

```{r, echo = FALSE, results = "asis"} 
cat(
  "\\begin{align*}",
  latex$g,
  "\\end{align*}",
  sep = ""
)
```

### Numerical

Values can be placed on the `par.label` column.

```{r}
eq <- "
# lhs op   rhs par.label
# factor loadings
  F1  by   y1  1
  F1  by   y2  1
  F1  by   y3  1
  F2  by   y4  1
  F2  by   y5  1
  F2  by   y6  1
  F3  by   y7  1
  F3  by   y8  1
  F3  by   y9  1
# intercepts
  y1  on   1   0
  y2  on   1   0
  y3  on   1   0
  y4  on   1   0
  y5  on   1   0
  y6  on   1   0
  y7  on   1   0
  y8  on   1   0
  y9  on   1   0
# residual variances
  y1  with y1  0.50
  y2  with y2  0.50
  y3  with y3  0.50
  y4  with y4  0.50
  y5  with y5  0.50
  y6  with y6  0.50
  y7  with y7  0.50
  y8  with y8  0.50
  y9  with y9  0.50
# covariances
  F1  with F1  1
  F1  with F2  0.50
  F1  with F3  0.50
  F2  with F2  1
  F2  with F3  0.50
  F3  with F3  1
"
```

#### Eq2RAM

The `Eq2RAM()` function constructs
the RAM notation matrix representation of the model.

```{r}
ramR::Eq2RAM(eq)
```

#### Eq2Expectations

The `Eq2Expectations()` function constructs the
mean and covariance expectations.

```{r}
Expectations <- ramR::Eq2Expectations(eq)
```

The covariance expectations for the observed variables `y1` to `y9`
are given below.

```{r, echo = FALSE, results = "asis"} 
cat(
  "\\begin{align*}",
  Ryacas::tex(Ryacas::ysym(Expectations$M)),
  "\\end{align*}",
  sep = ""
)
```

The mean expectations for the observed variables `y1` to `y9`
are given below.

```{r, echo = FALSE, results = "asis"} 
cat(
  "\\begin{align*}",
  Ryacas::tex(Ryacas::ysym(Expectations$g)),
  "\\end{align*}",
  sep = ""
)
```

#### Eq2Data

The `Eq2Data()` function simulates data from the multivariate normal distribution.

```{r}
Data <- ramR::Eq2Data(eq, n = 1000)
str(Data)
cov(Data)
colMeans(Data)
```
